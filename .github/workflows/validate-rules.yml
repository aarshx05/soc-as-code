name: Validate Rules (SOC-as-Code)

on:
  push:
    paths:
      - 'rules/**'
      - 'validator/**'
      - '.github/workflows/validate-rules.yml'
  pull_request:
    paths:
      - 'rules/**'
      - 'validator/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
      RESULTS_DIR: ${{ github.workspace }}/results
      ARTIFACTS_DIR: ${{ github.workspace }}/artifacts
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Add any project deps here (pyyaml etc)
          pip install pyyaml

      - name: Ensure directories
        run: |
          mkdir -p $RESULTS_DIR/baseline
          mkdir -p $RESULTS_DIR/current
          mkdir -p $ARTIFACTS_DIR
          mkdir -p $ARTIFACTS_DIR/reports

      # ---- Generate synthetic logs ----
      - name: Generate synthetic logs
        id: genlogs
        run: |
          # Adjust rules dir if required
          RULES_DIR="${{ github.workspace }}/rules/sigma"
          OUTPUT="${ARTIFACTS_DIR}/synthetic_logs.jsonl"
          mkdir -p "$(dirname "$OUTPUT")"
          python3 validator/generate_logs.py \
            --rules-dir "$RULES_DIR" \
            --output "$OUTPUT" \
            --limit 5000
          echo "logs=$OUTPUT" >> $GITHUB_OUTPUT

      # ---- Validate rules (current) ----
      - name: Validate rules (current)
        id: validate_current
        run: |
          # Validate changed rules only if you have a list; otherwise validate all
          python3 validator/validate_rules.py \
            --rules-dir rules/sigma \
            --debug || true
          # Run full validation that also invokes rule validation/runner to produce artifacts
          mkdir -p $RESULTS_DIR/current
          python3 validator/validate_rules.py --rules-dir rules/sigma --debug || true

      # ---- Run validator to produce current results (example) ----
      - name: Run rule validator (current run)
        id: run_validator_current
        run: |
          # This step runs the universal validator which produces validation_results and detections
          OUT_DIR="${RESULTS_DIR}/current"
          mkdir -p "$OUT_DIR"
          python3 validator/validate_rules.py --rules-dir rules/sigma --debug
          # If you instead use the big validator file you pasted, adjust invocation:
          # python3 validator/validate_rules.py --all-sigma-rules rules/sigma --synthetic-logs-dir "${ARTIFACTS_DIR}" --output-dir "${OUT_DIR}" --mode current

      # ---- (Optional) Run baseline validator if you have a baseline commit or saved results ----
      # If your CI uses a saved baseline, restore it here. Otherwise skip baseline or run with mode=baseline.
      #- name: Prepare baseline results
      #  run: |
      #    mkdir -p $RESULTS_DIR/baseline
      #    cp -r baseline_artifacts/* $RESULTS_DIR/baseline || true

      # ---- Compare & classify rules ----
      - name: Compare and classify (delta)
        id: classify
        run: |
          mkdir -p $ARTIFACTS_DIR/classification
          python3 validator/compare_and_classify.py \
            --baseline-results "$RESULTS_DIR/baseline" \
            --current-results "$RESULTS_DIR/current" \
            --rules-dir rules/sigma \
            --changed-sigma-rules "" \
            --output-file "${ARTIFACTS_DIR}/classification.json" \
            --debug || true

      # ---- Check results (sanity) ----
      - name: Check results (sanity)
        id: check_results
        run: |
          python3 validator/check_results.py \
            --baseline-results "$RESULTS_DIR/baseline" \
            --current-results "$RESULTS_DIR/current" \
            --output-report "${ARTIFACTS_DIR}/results_summary.json" \
            --debug || true

      # ---- Generate human-friendly report ----
      - name: Generate CI report (JSON + HTML)
        id: gen_report
        run: |
          mkdir -p "${ARTIFACTS_DIR}/reports"
          python3 validator/generate_report.py \
            --input-file "${ARTIFACTS_DIR}/classification.json" \
            --output-json "${ARTIFACTS_DIR}/reports/report_summary.json" \
            --output-html "${ARTIFACTS_DIR}/reports/report.html" \
            --debug || true

      # ---- Upload artifacts to the run ----
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: soc-as-code-artifacts
          path: |
            ${ARTIFACTS_DIR}/synthetic_logs.jsonl
            ${ARTIFACTS_DIR}/classification.json
            ${ARTIFACTS_DIR}/results_summary.json
            ${ARTIFACTS_DIR}/reports/report.html
            results/current/validation_results.json
            results/current/detections.json

      - name: Upload raw results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-validation-results
          path: results/current
