name: Validate Security Rules (Delta-Based)

on:
  push:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'
  pull_request:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'

jobs:
  validate-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Detect changed rules
        id: changed-rules
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt || true
          echo "ðŸ“‹ Changed files:"
          cat changed_files.txt || true
          
          SIGMA_RULES=$(grep -E "^rules/sigma/.*\.(yml|yaml)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "sigma_rules=${SIGMA_RULES}" >> $GITHUB_OUTPUT
          
          YARA_RULES=$(grep -E "^rules/yara/.*\.(yara|yar)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "yara_rules=${YARA_RULES}" >> $GITHUB_OUTPUT
          
          if [ -z "$SIGMA_RULES" ] && [ -z "$YARA_RULES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No rule changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Rule changes detected"
          fi
          
          if [ -n "$SIGMA_RULES" ]; then
            echo "ðŸ“„ Changed Sigma rules: $SIGMA_RULES"
          fi
          if [ -n "$YARA_RULES" ]; then
            echo "ðŸ“„ Changed YARA rules: $YARA_RULES"
          fi

      # =================================================================
      # BASELINE: Generate logs and run OLD rules only
      # =================================================================
      
      - name: "[BASELINE] Checkout OLD rules"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ•’ BASELINE: Checking out OLD rules (HEAD~1)"
          echo "============================================================"
          git stash
          git checkout HEAD~1
          
          echo "ðŸ“‚ OLD rule directory contents:"
          ls -la rules/sigma/ 2>/dev/null || echo "  No Sigma rules found"
          ls -la rules/yara/ 2>/dev/null || echo "  No YARA rules found"

      - name: "[BASELINE] Generate synthetic logs from OLD rules"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ§ª BASELINE: Generating logs from OLD rules"
          echo "============================================================"
          
          if [ -d "rules/sigma" ]; then
            python validator/generate_logs.py \
              --rules-dir rules/sigma \
              --output-dir synthetic_logs/baseline \
              --log-count 200
            
            LOG_COUNT=$(find synthetic_logs/baseline -name "*.jsonl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "âœ… Generated $LOG_COUNT baseline logs"
          else
            echo "âš ï¸  No OLD Sigma rules found, creating empty baseline"
            mkdir -p synthetic_logs/baseline
            touch synthetic_logs/baseline/empty.jsonl
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: "[BASELINE] Run detection on OLD rules"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸŽ¯ BASELINE: Running detection with OLD rules"
          echo "============================================================"
          
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --synthetic-logs-dir synthetic_logs/baseline \
            --output-dir validation_results/baseline \
            --mode baseline
          
          if [ -f "validation_results/baseline/detections.json" ]; then
            BASELINE_COUNT=$(jq 'length' validation_results/baseline/detections.json)
            echo "âœ… Baseline detections: $BASELINE_COUNT"
          else
            echo "âš ï¸  No baseline detections file created"
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: "[BASELINE] Return to current branch"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "ðŸ”„ Returning to current branch..."
          git checkout -
          git stash pop || true
          echo "âœ… Back on current branch"

      # =================================================================
      # CURRENT: Generate logs and run OLD + NEW rules
      # =================================================================

      - name: "[CURRENT] Generate synthetic logs from ALL rules"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ§ª CURRENT: Generating logs from ALL rules (old + new)"
          echo "============================================================"
          
          if [ -d "rules/sigma" ]; then
            python validator/generate_logs.py \
              --rules-dir rules/sigma \
              --output-dir synthetic_logs/current \
              --log-count 200
            
            LOG_COUNT=$(find synthetic_logs/current -name "*.jsonl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "âœ… Generated $LOG_COUNT current logs"
          else
            echo "âš ï¸  No Sigma rules found"
            mkdir -p synthetic_logs/current
            touch synthetic_logs/current/empty.jsonl
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: "[CURRENT] Run detection on ALL rules"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸŽ¯ CURRENT: Running detection with ALL rules (old + new)"
          echo "============================================================"
          
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --synthetic-logs-dir synthetic_logs/current \
            --output-dir validation_results/current \
            --mode current
          
          if [ -f "validation_results/current/detections.json" ]; then
            CURRENT_COUNT=$(jq 'length' validation_results/current/detections.json)
            echo "âœ… Current detections: $CURRENT_COUNT"
          else
            echo "âš ï¸  No current detections file created"
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      # =================================================================
      # DELTA CALCULATION & CLASSIFICATION
      # =================================================================

      - name: "[DELTA] Calculate and classify"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ“Š DELTA: Calculating detection difference"
          echo "============================================================"
          
          # Check both detection files exist
          if [ ! -f "validation_results/baseline/detections.json" ]; then
            echo "âŒ Baseline detections not found!"
            exit 1
          fi
          
          if [ ! -f "validation_results/current/detections.json" ]; then
            echo "âŒ Current detections not found!"
            exit 1
          fi
          
          # Show detection counts
          BASELINE_COUNT=$(jq 'length' validation_results/baseline/detections.json)
          CURRENT_COUNT=$(jq 'length' validation_results/current/detections.json)
          DELTA=$((CURRENT_COUNT - BASELINE_COUNT))
          
          echo "ðŸ“ˆ Detection Counts:"
          echo "   Baseline (old rules): $BASELINE_COUNT"
          echo "   Current (old + new): $CURRENT_COUNT"
          echo "   Delta (contribution): $DELTA"
          
          if [ $DELTA -gt 0 ]; then
            echo "âœ… New rules added $DELTA detections"
          elif [ $DELTA -eq 0 ]; then
            echo "âš ï¸  No new detections from new rules"
          else
            echo "âŒ Negative delta detected - serious issue!"
          fi
          
          # Run classification
          python validator/compare_and_classify.py \
            --baseline-results validation_results/baseline \
            --current-results validation_results/current \
            --changed-sigma-rules "${{ steps.changed-rules.outputs.sigma_rules }}" \
            --changed-yara-rules "${{ steps.changed-rules.outputs.yara_rules }}" \
            --output-file validation_results/classification_report.json
          
          echo "âœ… Classification complete"
        env:
          PYTHONPATH: ${{ github.workspace }}

      # =================================================================
      # RESULTS & REPORTING
      # =================================================================

      - name: "Check validation results"
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ” Checking validation results"
          echo "============================================================"
          
          python validator/check_results.py \
            --results-dir validation_results/current \
            --classification-report validation_results/classification_report.json \
            --fail-on-bad-rules true
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: "Generate summary report"
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "ðŸ“„ Generating summary report"
          echo "============================================================"
          
          if [ -f "validation_results/classification_report.json" ]; then
            python validator/generate_report.py \
              --classification-report validation_results/classification_report.json \
              --output-file validation_results/SUMMARY.md
            
            echo "âœ… Report generated successfully"
            echo ""
            echo "ðŸ“‹ Summary Preview:"
            head -50 validation_results/SUMMARY.md
          else
            echo "âš ï¸  Classification report not found, creating error summary"
            mkdir -p validation_results
            cat > validation_results/SUMMARY.md << 'EOFMARKER'
          # âŒ Validation Failed
          
          **Status:** Error - Validation process incomplete
          
          ## Issues Detected:
          
          The validation pipeline encountered an error before classification could complete.
          
          ### Possible Causes:
          1. ðŸ”´ **Baseline or current detection generation failed**
             - Check if synthetic logs were generated correctly
             - Verify rule syntax is valid
          
          2. ðŸ”´ **Rule validation errors**
             - Check for syntax errors in YAML files
             - Verify field names match log sources
          
          3. ðŸ”´ **Detection file missing**
             - Ensure both baseline and current detections.json exist
          
          ### Next Steps:
          1. Review the GitHub Actions logs for detailed error messages
          2. Run `python validator/diagnose_rule.py rules/sigma/your_rule.yml` locally
          3. Fix identified issues and push again
          
          ---
          
          ðŸ’¡ **Tip**: Test rules locally before pushing:
          ```bash
          python validator/diagnose_rule.py rules/sigma/your_rule.yml
          ```
          EOFMARKER
            echo "Created error summary report"
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: "Upload validation artifacts"
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation_results/**
            synthetic_logs/**
          retention-days: 30

      - name: "Comment PR with results"
        if: github.event_name == 'pull_request' && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summaryPath = 'validation_results/SUMMARY.md';
            
            if (fs.existsSync(summaryPath)) {
              const summary = fs.readFileSync(summaryPath, 'utf8');
              
              // Add workflow run link
              const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              const enhancedSummary = `${summary}

---

ðŸ“Š **Validation Method:** Delta-Based Detection Count Comparison

ðŸ”— **Full Workflow Logs:** [View Details](${runUrl})

â¬‡ï¸ **Artifacts:** Download validation results from the workflow run above
`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: enhancedSummary
              });
              
              console.log('âœ… Posted summary to PR');
            } else {
              console.log('âš ï¸  Summary file not found');
            }

      - name: "Show final status"
        if: always()
        run: |
          echo ""
          echo "============================================================"
          echo "ðŸ VALIDATION PIPELINE COMPLETE"
          echo "============================================================"
          echo ""
          
          if [ "${{ steps.changed-rules.outputs.has_changes }}" == "true" ]; then
            if [ -f "validation_results/classification_report.json" ]; then
              echo "âœ… Validation successful - results available"
              echo ""
              echo "ðŸ“‚ Artifacts created:"
              echo "   â€¢ validation_results/classification_report.json"
              echo "   â€¢ validation_results/SUMMARY.md"
              echo "   â€¢ synthetic_logs/baseline/ and current/"
              echo ""
              echo "ðŸ“Š Review the classification report for detailed analysis"
            else
              echo "âŒ Validation failed - check logs above"
            fi
          else
            echo "âš ï¸  No rule changes detected - skipped validation"
          fi
          
          echo ""
          echo "============================================================"
