name: Validate Security Rules

on:
  push:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'
  pull_request:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'

jobs:
  validate-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Detect changed rules
        id: changed-rules
        run: |
          # list changed files between last two commits (works for push)
          git diff --name-only HEAD~1 HEAD > changed_files.txt || true
          echo "Changed files:"
          cat changed_files.txt || true

          # Extract changed Sigma rules (.yml or .yaml)
          SIGMA_RULES=$(grep -E "^rules/sigma/.*\.(yml|yaml)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "sigma_rules=${SIGMA_RULES}" >> $GITHUB_OUTPUT

          # Extract changed YARA rules (.yara or .yar)
          YARA_RULES=$(grep -E "^rules/yara/.*\.(yara|yar)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "yara_rules=${YARA_RULES}" >> $GITHUB_OUTPUT

          # Check if any rules changed
          if [ -z "$SIGMA_RULES" ] && [ -z "$YARA_RULES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate synthetic logs from all existing rules
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Generating synthetic logs from all existing Sigma rules..."
          python validator/generate_logs.py \
            --rules-dir rules/sigma \
            --output-dir synthetic_logs \
            --log-count 100
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Validate OLD rules (baseline)
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Step 1: Validating OLD rules against synthetic logs (baseline)..."
          
          # Checkout previous commit to get old rules
          git stash
          git checkout HEAD~1
          
          # Run validation with old rules only
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --synthetic-logs-dir synthetic_logs \
            --output-dir validation_results/baseline \
            --mode baseline
          
          # Return to current commit
          git checkout -
          git stash pop || true
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Validate NEW rules (with changes)
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Step 2: Validating NEW rules (old + new) against synthetic logs..."
          
          # Run validation with all current rules (including new ones)
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --changed-sigma-rules "${{ steps.changed-rules.outputs.sigma_rules }}" \
            --changed-yara-rules "${{ steps.changed-rules.outputs.yara_rules }}" \
            --synthetic-logs-dir synthetic_logs \
            --output-dir validation_results/current \
            --mode current
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Compare and classify new rules
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Step 3: Comparing baseline vs current and classifying new rules..."
          
          python validator/compare_and_classify.py \
            --baseline-results validation_results/baseline \
            --current-results validation_results/current \
            --changed-sigma-rules "${{ steps.changed-rules.outputs.sigma_rules }}" \
            --changed-yara-rules "${{ steps.changed-rules.outputs.yara_rules }}" \
            --output-file validation_results/classification_report.json
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Check validation results and rule quality
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Step 4: Checking final validation results..."
          
          python validator/check_results.py \
            --results-dir validation_results \
            --classification-report validation_results/classification_report.json \
            --fail-on-bad-rules true

      - name: Generate summary report
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "Generating human-readable summary report..."
          
          python validator/generate_report.py \
            --classification-report validation_results/classification_report.json \
            --output-file validation_results/SUMMARY.md
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload validation artifacts
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation_results/**
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('validation_results/SUMMARY.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });