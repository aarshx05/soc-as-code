name: SOC-as-Code CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily security scans at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Dataset to analyze'
        required: false
        default: 'synthetic_test_logs_large.jsonl'
      severity_threshold:
        description: 'Fail on severity (low/medium/high/critical)'
        required: false
        default: 'high'

env:
  PYTHON_VERSION: '3.9'
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

jobs:
  # ==========================================
  # Job 1: Code Quality & Testing
  # ==========================================
  code-quality:
    name: Code Quality & Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install pyyaml yara-python flask reportlab requests
        pip install pytest pytest-cov pylint black flake8
        
    - name: Code Formatting Check (Black)
      run: |
        black --check --diff *.py || echo "Code formatting issues detected"
        
    - name: Linting (Flake8)
      run: |
        flake8 *.py --max-line-length=120 --ignore=E203,W503 || echo "Linting issues detected"
        
    - name: Run Built-in Sample Tests
      run: |
        python test.py --run-samples
        
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: |
          *.log
          test_output/

  # ==========================================
  # Job 2: Generate Synthetic Test Data
  # ==========================================
  generate-test-data:
    name: Generate Synthetic Logs
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        pip install pyyaml yara-python
        
    - name: Generate Synthetic Workspace
      run: |
        python test.py --generate-synthetic ./synthetic_workspace --count 500 --yara-generate
        
    - name: Verify Generated Files
      run: |
        ls -la synthetic_workspace/
        ls -la synthetic_workspace/logs/
        ls -la synthetic_workspace/rules/
        ls -la synthetic_workspace/yara/
        
    - name: Upload Synthetic Data
      uses: actions/upload-artifact@v3
      with:
        name: synthetic-workspace
        path: synthetic_workspace/

  # ==========================================
  # Job 3: SOC Simulation - Sigma Rules
  # ==========================================
  soc-simulation-sigma:
    name: SOC Simulation (Sigma Rules)
    runs-on: ubuntu-latest
    needs: generate-test-data
    
    strategy:
      matrix:
        dataset:
          - synthetic_test_logs_large.jsonl
        severity: [medium, high, critical]
      fail-fast: false
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        pip install pyyaml yara-python
        
    - name: Download Synthetic Data
      uses: actions/download-artifact@v3
      with:
        name: synthetic-workspace
        path: synthetic_workspace/
        
    - name: Run SOC Simulator (Sigma)
      id: soc-run
      continue-on-error: true
      run: |
        python test.py \
          --logs synthetic_workspace/logs/synthetic.jsonl \
          --sigma synthetic_workspace/rules/sigma_synthetic.yml \
          --out output/alerts_${{ matrix.severity }}.json \
          --metrics output/metrics_${{ matrix.severity }}.json \
          --fail-on-severity ${{ matrix.severity }}
        
    - name: Check Simulation Results
      run: |
        if [ -f output/alerts_${{ matrix.severity }}.json ]; then
          echo "Alerts generated:"
          cat output/alerts_${{ matrix.severity }}.json | python -m json.tool | head -50
        fi
        
    - name: Upload Simulation Results
      uses: actions/upload-artifact@v3
      with:
        name: soc-results-sigma-${{ matrix.severity }}
        path: output/

  # ==========================================
  # Job 4: SOC Simulation - Full Stack (Sigma + YARA)
  # ==========================================
  soc-simulation-full:
    name: Full SOC Simulation (Sigma + YARA)
    runs-on: ubuntu-latest
    needs: generate-test-data
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        pip install pyyaml yara-python flask reportlab requests
        
    - name: Download Synthetic Data
      uses: actions/download-artifact@v3
      with:
        name: synthetic-workspace
        path: synthetic_workspace/
        
    - name: Run Full SOC Simulation
      run: |
        python test.py \
          --logs synthetic_workspace/logs/synthetic.jsonl \
          --sigma synthetic_workspace/rules/sigma_synthetic.yml \
          --yara synthetic_workspace/yara/synthetic.yar \
          --out output/alerts_full.json \
          --metrics output/metrics_full.json
        
    - name: Generate Executive Report
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      run: |
        python run_soc.py \
          --logs synthetic_workspace/logs/synthetic.jsonl \
          --sigma synthetic_workspace/rules/sigma_synthetic.yml \
          --yara synthetic_workspace/yara/synthetic.yar \
          --output-dir output/
        
    - name: Upload Full Results
      uses: actions/upload-artifact@v3
      with:
        name: soc-results-full
        path: output/
        
    - name: Upload Executive Report
      uses: actions/upload-artifact@v3
      with:
        name: executive-report
        path: output/*.pdf

  # ==========================================
  # Job 5: Real Dataset Analysis (if available)
  # ==========================================
  real-dataset-analysis:
    name: Real Dataset Analysis
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Dependencies
      run: |
        pip install pyyaml yara-python flask reportlab requests
        
    - name: Check for Real Datasets
      id: check-datasets
      run: |
        if [ -d "dataset" ] && [ "$(ls -A dataset)" ]; then
          echo "datasets_exist=true" >> $GITHUB_OUTPUT
          echo "Real datasets found:"
          ls -la dataset/
        else
          echo "datasets_exist=false" >> $GITHUB_OUTPUT
          echo "No real datasets found, skipping analysis"
        fi
        
    - name: Run Analysis on Real Data
      if: steps.check-datasets.outputs.datasets_exist == 'true'
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      run: |
        for dataset in dataset/*.jsonl; do
          if [ -f "$dataset" ]; then
            basename=$(basename "$dataset" .jsonl)
            python run_soc.py \
              --logs "$dataset" \
              --sigma indata/sigma_test_rules_extensive.yml \
              --yara indata/malicious_extensive.yar \
              --output-dir "output/${basename}/"
          fi
        done
        
    - name: Upload Real Dataset Results
      if: steps.check-datasets.outputs.datasets_exist == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: real-dataset-results
        path: output/

  # ==========================================
  # Job 6: Security & Compliance Reporting
  # ==========================================
  security-report:
    name: Generate Security Dashboard
    runs-on: ubuntu-latest
    needs: [soc-simulation-sigma, soc-simulation-full]
    if: always()
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Download All Results
      uses: actions/download-artifact@v3
      with:
        path: all-results/
        
    - name: Generate Consolidated Report
      run: |
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        
        print("# SOC-as-Code Security Report")
        print(f"Generated: {datetime.now().isoformat()}")
        print(f"Commit: ${{ github.sha }}")
        print(f"Branch: ${{ github.ref_name }}")
        print("\n## Summary\n")
        
        total_alerts = 0
        severity_counts = {"low": 0, "medium": 0, "high": 0, "critical": 0}
        
        results_dir = "all-results"
        if os.path.exists(results_dir):
            for root, dirs, files in os.walk(results_dir):
                for file in files:
                    if file.startswith("alerts_") and file.endswith(".json"):
                        filepath = os.path.join(root, file)
                        try:
                            with open(filepath) as f:
                                data = json.load(f)
                                alerts = data.get("alerts", [])
                                total_alerts += len(alerts)
                                for alert in alerts:
                                    sev = alert.get("severity", "unknown").lower()
                                    if sev in severity_counts:
                                        severity_counts[sev] += 1
                        except Exception as e:
                            print(f"Error reading {filepath}: {e}")
        
        print(f"**Total Alerts Generated:** {total_alerts}\n")
        print("### Alerts by Severity\n")
        for sev in ["critical", "high", "medium", "low"]:
            count = severity_counts[sev]
            print(f"- **{sev.upper()}:** {count}")
        
        print("\n## Recommendations\n")
        if severity_counts["critical"] > 0:
            print("âš ï¸ **CRITICAL:** Immediate investigation required for critical alerts")
        if severity_counts["high"] > 10:
            print("âš ï¸ **HIGH:** Review and tune rules generating excessive high-severity alerts")
        if total_alerts > 100:
            print("ðŸ’¡ Consider rule optimization to reduce noise")
        
        print("\n---\n*This report was automatically generated by SOC-as-Code CI/CD*")
        EOF
        
    - name: Create Summary Comment Body
      id: summary
      run: |
        echo "## ðŸ›¡ï¸ SOC-as-Code Analysis Complete" > summary.md
        echo "" >> summary.md
        echo "**Commit:** \`${{ github.sha }}\`" >> summary.md
        echo "**Branch:** \`${{ github.ref_name }}\`" >> summary.md
        echo "**Triggered by:** ${{ github.actor }}" >> summary.md
        echo "" >> summary.md
        echo "### ðŸ“Š Results Available" >> summary.md
        echo "- Sigma rule analysis" >> summary.md
        echo "- Full stack simulation (Sigma + YARA)" >> summary.md
        echo "- Executive report (PDF)" >> summary.md
        echo "" >> summary.md
        echo "Download artifacts from the Actions run to view detailed results." >> summary.md
        
    - name: Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-dashboard
        path: summary.md

  # ==========================================
  # Job 7: Deployment Check (Web UI)
  # ==========================================
  deployment-check:
    name: Web UI Deployment Check
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install Flask Dependencies
      run: |
        pip install flask pyyaml yara-python reportlab requests
        
    - name: Check Flask App Syntax
      run: |
        python -m py_compile app.py
        
    - name: Test Flask App Startup
      run: |
        timeout 10 python app.py &
        sleep 5
        curl http://localhost:5000 || echo "Flask app started successfully"
        
    - name: Security Check - Secret Key
      run: |
        if grep -q "change-this-secret" app.py; then
          echo "âš ï¸ WARNING: Default secret key detected in app.py"
          echo "Set a secure secret key before production deployment"
        fi

  # ==========================================
  # Job 8: Notification & Badges
  # ==========================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [soc-simulation-full, security-report]
    if: always()
    
    steps:
    - name: Check Job Status
      run: |
        echo "Pipeline Status: ${{ job.status }}"
        echo "Needs Status: ${{ toJSON(needs) }}"
        
    - name: Create Status Badge
      run: |
        if [ "${{ needs.soc-simulation-full.result }}" == "success" ]; then
          echo "âœ… SOC Simulation: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ SOC Simulation: FAILED" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Summary
      run: |
        echo "## ðŸŽ¯ Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Sigma Simulation | ${{ needs.soc-simulation-sigma.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Full Simulation | ${{ needs.soc-simulation-full.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Report | ${{ needs.security-report.result }} |" >> $GITHUB_STEP_SUMMARY