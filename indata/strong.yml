# High-precision Sigma rules - low noise

# 1) PowerShell invoked with encoded command and remote download (very suspicious)
- title: "PowerShell encoded command with remote download"
  id: "SIG-HP-001"
  level: high
  detection:
    sel_a:
      EventID: 4688
      NewProcessName: ".*powershell(?:\\.exe)?$"
    sel_b:
      CommandLine: ".*-EncodedCommand .*|.*DownloadString\\(|.*Invoke-WebRequest .*"
    condition: sel_a and sel_b

# 2) Command interpreter spawning from unusual parent (cmd spawned by explorer is normal; spawned by w3wp or unknown is suspicious)
- title: "cmd.exe spawned by uncommon parent process"
  id: "SIG-HP-002"
  level: high
  detection:
    sel_a:
      EventID: 4688
      NewProcessName: ".*\\\\cmd(?:\\.exe)?$"
    sel_b:
      ParentProcessName: ".*(w3wp|iisexpress|php-cgi|unknown)\\.exe$"
    condition: sel_a and sel_b

# 3) Web upload to .php with cmd parameter combined with POST and uncommon UA
- title: "Likely webshell upload POST to PHP with cmd param"
  id: "SIG-HP-003"
  level: high
  detection:
    sel_a:
      HttpMethod: POST
      RequestUri: "*cmd=*"
    sel_b:
      UserAgent: "*curl/*|*python-requests/*|*wget/*"
    condition: sel_a and sel_b

# 4) Executable creation in per-user temp AND not from approved installer processes
- title: "EXE created in user Temp by non-installer process"
  id: "SIG-HP-004"
  level: high
  detection:
    sel_a:
      EventID: 4656
      TargetFilename: "C:\\Users\\*\\AppData\\Local\\Temp\\*.exe"
    sel_b:
      InitiatingProcess: "!msiexec.exe|!setup.exe|!installer.exe"
    condition: sel_a and sel_b

# 5) High-confidence ransomware marker in message payloads (specific marker)
- title: "Ransomware encryption marker observed"
  id: "SIG-HP-005"
  level: critical
  detection:
    sel_a:
      message: ".*:::ENCRYPTED:::.*"
    sel_b:
      file_action: "*encrypt*"
    condition: sel_a and sel_b

# 6) Outbound RDP from internal server to internet (rare; suspicious)
- title: "Internal host initiating RDP to public IP"
  id: "SIG-HP-006"
  level: high
  detection:
    sel_a:
      event_type: network
      DestPort: 3389
    sel_b:
      DestinationIp: "^(?!10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.).+$"
    condition: sel_a and sel_b

# 7) Account 'svc_' or 'admin' that is seldom used performing interactive logon
- title: "Privileged service account interactive logon"
  id: "SIG-HP-007"
  level: high
  detection:
    sel_a:
      EventID: 4624
      LogonType: 2
    sel_b:
      TargetUserName: "^(svc_|admin|root).*"
    condition: sel_a and sel_b

# 8) WMI remote process creation combined with network connection to odd port
- title: "WMI process creation with unusual outbound port"
  id: "SIG-HP-008"
  level: high
  detection:
    sel_a:
      EventID: 5861
      ProcessName: ".*wmic(?:\\.exe)?$"
      CommandLine: ".*process call create.*"
    sel_b:
      event_type: network
      DestPort: 4444
    condition: sel_a and sel_b

# 9) Known malicious file hash (exact match) - exact equality (low false positive)
- title: "Known-malware file hash match"
  id: "SIG-HP-009"
  level: critical
  detection:
    sel_a:
      file_hash: "SHA256:3f786850e387550fdab836ed7e6dc881de23001b"  # replace with real hashes
    condition: sel_a

# 10) MSI install invoked from non-admin context and unusual product name
- title: "MSI install by non-privileged user with odd product name"
  id: "SIG-HP-010"
  level: high
  detection:
    sel_a:
      EventID: 1033
      ProductName: "^(?!Microsoft).*Visual.*"
    sel_b:
      user: "^(?!DOMAIN\\\\Administrator|SYSTEM).*"
    condition: sel_a and sel_b

# 11) POST to upload.php with both cmd parameter and long suspicious User-Agent (bot-like)
- title: "Webshell POST from automated tool"
  id: "SIG-HP-011"
  level: medium
  detection:
    sel_a:
      HttpMethod: POST
      RequestUri: "/upload.php?cmd=*"
    sel_b:
      UserAgent: "*python-requests/*|*curl/*|*Wget/*"
    condition: sel_a and sel_b

# 12) Repeated failed login bursts exceeding threshold (engine may not support counters; approximate by clustered failures)
- title: "Burst of failed logins (clustered failures)"
  id: "SIG-HP-012"
  level: medium
  detection:
    sel_a:
      EventID: 4625
      FailureReason: "*bad password*"
    sel_b:
      host: "^(?!workstation-exempt-).*"
    condition: sel_a and sel_b

# 13) Rare registry Run key create (persistence) for non-whitelisted service names
- title: "Registry persistence Run key created for non-approved service"
  id: "SIG-HP-013"
  level: high
  detection:
    sel_a:
      event_type: registry
      Key: "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
    sel_b:
      Value: "^(?!OneDrive|Adobe|Google).*"
    condition: sel_a and sel_b

# 14) Outbound connection to known suspicious domain names (exact domain)
- title: "Connection to known suspicious domain"
  id: "SIG-HP-014"
  level: high
  detection:
    sel_a:
      event_type: dns
      query: "^(callback\\.evil\\.org|malicious\\.ru)$"
    condition: sel_a

# 15) File write of .encrypted or ransom extension by non-antivirus process
- title: "Creation of encrypted/ransom file extension by non-av"
  id: "SIG-HP-015"
  level: critical
  detection:
    sel_a:
      EventID: 4663
      FileName: ".*\\.(locked|encrypted|crypt)$"
    sel_b:
      ProcessName: "^(?!MsMpEng\\.exe|avp\\.exe|savservice\\.exe).*"
    condition: sel_a and sel_b
